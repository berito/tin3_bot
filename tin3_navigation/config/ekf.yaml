# EKF Configuration for tin3_bot
# Fuses: wheel odometry + IMU
# Output: /odom_filtered (or /{robot_ns}/odom_filtered when namespaced)

### EKF Node Configuration ###
ekf_filter_node:
  ros__parameters:
    # Use simulation time
    use_sim_time: true
    # ----- Frame Configuration -----
    # These will be overridden by launch file for namespaced robots
    odom_frame: odom
    base_link_frame: base_link
    world_frame: odom       # Use 'odom' for local odometry, 'map' if using AMCL
    map_frame: map

    # ----- Publishing -----
    frequency: 30.0         # EKF update rate (Hz)
    publish_tf: true        # Publish odom -> base_link transform
    publish_acceleration: false

    # ----- Sensor Timeout -----
    sensor_timeout: 0.1

    # ----- Transform Timeout -----
    transform_time_offset: 0.0
    transform_timeout: 0.0

    # =========================================================
    # SENSOR 0: Wheel Odometry (from Gazebo DiffDrive)
    # =========================================================
    # Topic: /odom (or /{robot_ns}/odom)
    # Message: nav_msgs/Odometry
    #
    # DiffDrive provides:
    # - Position: x, y (from wheel encoders)
    # - Orientation: yaw (from wheel encoders)
    # - Velocity: vx, vyaw (from wheel encoders)
    # =========================================================
    odom0: odom
    odom0_queue_size: 10

    # Configuration matrix: [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
    #                        0  1  2   3     4      5   6   7   8    9      10      11   12  13  14
    odom0_config: [
      true,  true,  false,   # x, y, z (use x, y from wheel odom)
      false, false, false,   # roll, pitch, yaw (don't use pose orientation - use velocity instead)
      true,  false, false,   # vx, vy, vz (use vx from wheel odom)
      false, false, true,    # vroll, vpitch, vyaw (use vyaw from wheel odom)
      false, false, false    # ax, ay, az (not available)
    ]

    odom0_differential: false    # Use absolute pose, not differential
    odom0_relative: false        # Pose is in odom frame, not relative to first measurement
    odom0_nodelay: false

    # =========================================================
    # SENSOR 1: IMU
    # =========================================================
    # Topic: /imu/data (or /{robot_ns}/imu/data)
    # Message: sensor_msgs/Imu
    #
    # IMU provides:
    # - Orientation: roll, pitch, yaw (from accelerometer + gyro)
    # - Angular velocity: vroll, vpitch, vyaw
    # - Linear acceleration: ax, ay, az
    #
    # For ground robots, we primarily want:
    # - Angular velocity (vyaw) for better rotation estimation
    # - Linear acceleration (ax) can help detect motion
    # =========================================================
    imu0: imu/data
    imu0_queue_size: 10

    # Configuration matrix: [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
    #                        0  1  2   3     4      5   6   7   8    9      10      11   12  13  14
    imu0_config: [
      false, false, false,   # x, y, z (IMU doesn't provide position)
      false, false, false,   # roll, pitch, yaw (don't use orientation - can drift)
      false, false, false,   # vx, vy, vz (IMU doesn't provide linear velocity)
      true,  true,  true,    # vroll, vpitch, vyaw (use angular velocity - high quality from gyro)
      false, false, false    # ax, ay, az (skip accel for ground robot - noise issues)
    ]

    imu0_differential: false
    imu0_relative: false
    imu0_nodelay: false
    imu0_remove_gravitational_acceleration: true

    # =========================================================
    # Process Noise Covariance (Q matrix)
    # =========================================================
    # How much the state can change between updates
    # Smaller = trust model more, larger = allow more change
    # Diagonal: [x, y, z, roll, pitch, yaw, vx, vy, vz, vroll, vpitch, vyaw, ax, ay, az]
    process_noise_covariance: [
      0.05,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.05,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.06,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.03,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.03,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.06,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.025, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.025, 0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.04,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.02,  0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.01,  0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.015
    ]

    # =========================================================
    # Initial Estimate Covariance (P0 matrix)
    # =========================================================
    # Initial uncertainty in state estimate
    # Larger = more uncertain initially
    initial_estimate_covariance: [
      1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,   0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9,  0.0,
      0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   0.0,   1e-9
    ]